---
layout: post
title: "NOTEs"
author: "zoyeal"
categories: doc
tags: [normal, records]
image: "https://coding.net/u/zoyeal/p/zoyeal.io/git/raw/master/notes.jpg"
---

&nbsp;

#### 只是临时笔记！！！

&nbsp;


# config.py

---

# -*- coding:utf-8 -*-

# 此为企业的ID号
CorpID = 'ww4687459cadcc7eb0'

# 应用的ID
Agentid = 1000002

# 认证信息，企业ID+认证信息可获取tokent，获取之后向此tokent发送内容
Secret = 'RifuPruZDknsSX2O3I9MwlbR7WFIcWheWfT9Pt3pWXo'

--- 

# runApp.py

# encoding: utf-8

from flask import Flask, abort, request
import wechat

app = Flask(__name__)


# http://172.16.9.119:9209/alert?user=dengdacheng&title=【程序执行异常】&msg=这是一条测试信息 数据异常告警
@app.route('/alert/', methods=['GET', 'POST'])
def alert():
    # 创建对象
    send_obj = wechat.Tencent(request.args.get('user'), request.args.get('title'), request.args.get('msg'))
    # 调用发送函数
    return send_obj.send_message()


if __name__ == '__main__':
    app.run(host='172.16.77.33', port=9209)


# wechat.py
---

#!/usr/bin/env python
# -*- coding:utf-8 -*-

from config import CorpID, Agentid, Secret
import urllib.request
import json
import time

localtime = time.strftime("[%Y-%m-%d %H:%M:%S]", time.localtime())


class Tencent(object):
    def __init__(self, user, title, msg):

        self.MSG = title + '\r\n' + msg + '\r\n' + localtime
        self.User = user
        self.url = 'https://qyapi.weixin.qq.com'
        self.send_msg = json.dumps({
            "touser": self.User,
            "msgtype": "text",
            "agentid": Agentid,
            "text": {"content": self.MSG},
            "safe": 0

        })

    def get_token(self):
        token_url = '%s/cgi-bin/gettoken?corpid=%s&corpsecret=%s' % (self.url, CorpID, Secret)
        token = json.loads(urllib.request.urlopen(token_url).read())['access_token']
        return token

    def send_message(self):
        send_url = '%s/cgi-bin/message/send?access_token=%s' % (self.url, self.get_token())
        print(self.send_msg)
        response = urllib.request.urlopen(url=send_url, data=bytes(self.send_msg, 'utf8')).read()
        x = json.loads(response.decode())['errcode']
        if x == 0:
            return 'Success'
        else:
            return 'Failed'



